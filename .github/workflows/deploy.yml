name: Build and Run Pipeline

on:
  workflow_run:
    workflows: ["CI Quality Checks"]
    types:
      - completed

jobs:
  build:
    name: Build and Run
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' && github.event.workflow_run.head_branch == 'main' }}
    steps:
      - name: Build and Run Algos
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DCISM_HOST }}
          username: ${{ secrets.DCISM_USERNAME }}
          password: ${{ secrets.DCISM_PASSWORD }}
          port: ${{ secrets.DCISM_PORT }}
          timeout: 60s
          script: |
            set -e

            APP_DIR="$HOME/${{ secrets.DCISM_SUBDOMAIN }}"
            PORT="${{ secrets.APP_PORT }}"

            cd "$APP_DIR" || exit 1

            echo "==> Update repo"
            git fetch --all
            git reset --hard origin/main
            git clean -fd

            echo "==> Install deps"
            npm install --legacy-peer-deps

            echo "==> Build"
            npx tsc -b --noCheck
            npx vite build

            echo "==> Restart PM2 (serve dist)"
            npx pm2 delete algos > /dev/null 2>&1 || true
            npx pm2 start "npx serve -s dist -l $PORT" --name "algos" > /dev/null 2>&1
            npx pm2 save > /dev/null 2>&1

            echo "âœ… Deployment Successful"
